AWSTemplateFormatVersion: '2010-09-09'
Description: RDS setup inside a VPC and storing connection credentials in Secrets Manager

Resources:

  CognitoUserDBSecret:
    Type: AWS::SecretsManager::Secret
    Properties:
      Name: CognitoUserDBConnection
      Description: Connection credentials for the Cognito user details RDS instance

  CognitoUserDB:
    Type: 'AWS::RDS::DBInstance'
    Properties:
      AllocatedStorage: '20'
      DBInstanceClass: 'db.t2.micro'
      Engine: 'mysql'
      MasterUsername: !Join ['', ['{{resolve:secretsmanager:', !Ref CognitoUserDBSecret, ':SecretString:username}}']]
      MasterUserPassword: !Join ['', ['{{resolve:secretsmanager:', !Ref CognitoUserDBSecret, ':SecretString:password}}']]
      DBName: 'CognitoUsers'
      MultiAZ: false
      BackupRetentionPeriod: '3'
      VPCSecurityGroups:
        - Ref: DBSecurityGroup
      DBSubnetGroupName: !Ref DBSubnetGroup
      DeletionPolicy: Snapshot

  DBSubnetGroup:
    Type: 'AWS::RDS::DBSubnetGroup'
    Properties:
      DBSubnetGroupDescription: Subnet group for CognitoUserDB
      SubnetIds:
        - subnet-xxxxx1  # Replace with your subnet IDs
        - subnet-xxxxx2

  DBSecurityGroup:
    Type: 'AWS::EC2::SecurityGroup'
    Properties:
      GroupDescription: Allow MySQL connections
      VpcId: vpc-xxxxx  # Replace with your VPC ID
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: '3306'
          ToPort: '3306'
          CidrIp: 0.0.0.0/0  # You might want to restrict this to your Lambda's security group or specific IPs
